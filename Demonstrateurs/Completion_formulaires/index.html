<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form Extractor</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Syne:wght@400;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f0f11;
      --surface: #18181c;
      --border: #2a2a32;
      --accent: #7c6aff;
      --accent-light: #a599ff;
      --text: #e8e8f0;
      --muted: #6b6b80;
      --success: #4ade80;
      --error: #f87171;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 2rem 3rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: baseline;
      gap: 1rem;
    }

    header h1 {
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text);
    }

    header span {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--accent-light);
      background: #7c6aff1a;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      border: 1px solid #7c6aff44;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      flex: 1;
      gap: 0;
    }

    .panel {
      padding: 2rem;
      border-right: 1px solid var(--border);
    }

    .panel:last-child { border-right: none; }

    .panel-title {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ── Panel 1 : formulaire visuel ── */
    .form-field {
      margin-bottom: 1.2rem;
    }

    label {
      display: block;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--muted);
      margin-bottom: 0.4rem;
      letter-spacing: 0.05em;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"] {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.65rem 0.9rem;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      transition: border-color 0.2s;
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
    }

    input.filled {
      border-color: var(--success);
      color: var(--success);
    }

    /* ── Panel 2 : texte + bouton ── */
    textarea {
      width: 100%;
      height: 180px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.9rem;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
    }

    textarea:focus { border-color: var(--accent); }

    .btn {
      margin-top: 1.2rem;
      width: 100%;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.9rem;
      border-radius: 8px;
      font-family: 'Syne', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .btn:hover { background: var(--accent-light); }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; }

    .loader {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #ffffff44;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Panel 3 : résultat ── */
    .result-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      min-height: 220px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.7;
      overflow: auto;
      white-space: pre;
    }

    .result-box.empty { color: var(--muted); }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      padding: 0.25rem 0.7rem;
      border-radius: 20px;
      margin-bottom: 1rem;
    }

    .status-badge.ok { background: #4ade8022; color: var(--success); border: 1px solid #4ade8044; }
    .status-badge.err { background: #f8717122; color: var(--error); border: 1px solid #f8717144; }
    .status-badge.waiting { background: #7c6aff22; color: var(--accent-light); border: 1px solid #7c6aff44; }

    /* JSON coloring */
    .json-key { color: var(--accent-light); }
    .json-str { color: #fbbf24; }
    .json-num { color: #34d399; }
    .json-bool { color: #f472b6; }
    .json-null { color: var(--muted); }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .panel { border-right: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>

<header>
  <h1>Form Extractor</h1>
  <span>POST /extract</span>
</header>

<div class="layout">

  <!-- Panel 1 : formulaire visuel -->
  <div class="panel">
    <div class="panel-title">Formulaire</div>
    <div id="visual-form">
      <div class="form-field">
        <label>Prénom</label>
        <input type="text" id="f_first_name" placeholder="—" readonly />
      </div>
      <div class="form-field">
        <label>Nom</label>
        <input type="text" id="f_last_name" placeholder="—" readonly />
      </div>
      <div class="form-field">
        <label>Email</label>
        <input type="email" id="f_email" placeholder="—" readonly />
      </div>
      <div class="form-field">
        <label>Age</label>
        <input type="number" id="f_age" placeholder="—" readonly />
      </div>
    </div>
  </div>

  <!-- Panel 2 : texte + bouton -->
  <div class="panel">
    <div class="panel-title">Texte source</div>
    <textarea id="text-input">Euh… bonjour… alors je m'appelle euh Thomas… Thomas Leroy et j'ai 20 ans. L'email c'est prénom point nom arrobase gmail point com.</textarea>
    <button class="btn" id="extract-btn" onclick="extract()">Extraire les données</button>
  </div>

  <!-- Panel 3 : résultat brut -->
  <div class="panel">
    <div class="panel-title">Réponse API</div>
    <div id="status-area"></div>
    <div class="result-box empty" id="result-box">En attente d'une requête…</div>
  </div>

</div>

<script>
  // ── Formulaire JSON en dur ──
  const FORM_SCHEMA = {
    fields: [
      { name: "first_name", label: "Prénom",  type: "text",  required: false, semantic_hint: "prénom de la personne" },
      { name: "last_name",  label: "Nom",     type: "text",  required: false, semantic_hint: "nom de famille" },
      { name: "email",      label: "Email",   type: "email", required: false, semantic_hint: "adresse email" },
      { name: "age",        label: "Age",     type: "int",   required: false, semantic_hint: "âge en années" }
    ]
  };

  // ── Appel API ──
  async function extract() {
    const btn = document.getElementById('extract-btn');
    const resultBox = document.getElementById('result-box');
    const statusArea = document.getElementById('status-area');
    const text = document.getElementById('text-input').value.trim();

    if (!text) return;

    // Reset UI
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Analyse…';
    resultBox.classList.remove('empty');
    resultBox.innerHTML = '';
    statusArea.innerHTML = '<div class="status-badge waiting">⏳ Requête en cours</div>';
    clearForm();

    const payload = { form: FORM_SCHEMA, text };

    try {
      const res = await fetch('http://127.0.0.1:8000/extract', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (res.ok) {
        statusArea.innerHTML = `<div class="status-badge ok">✓ ${res.status} OK</div>`;
        resultBox.innerHTML = colorizeJson(JSON.stringify(data, null, 2));
        fillForm(data);
      } else {
        statusArea.innerHTML = `<div class="status-badge err">✗ ${res.status} Erreur</div>`;
        resultBox.innerHTML = colorizeJson(JSON.stringify(data, null, 2));
      }

    } catch (err) {
      statusArea.innerHTML = '<div class="status-badge err">✗ Connexion échouée</div>';
      resultBox.classList.add('empty');
      resultBox.textContent = `Impossible de joindre l'API.\nVérifiez que le serveur tourne sur http://127.0.0.1:8000\n\n${err.message}`;
    } finally {
      btn.disabled = false;
      btn.textContent = 'Extraire les données';
    }
  }

  // ── Remplir le formulaire visuel avec la réponse ──
  function fillForm(data) {
    const values = data.data || data;
    FORM_SCHEMA.fields.forEach(f => {
      const input = document.getElementById('f_' + f.name);
      const val = values[f.name];
      if (input && val !== undefined && val !== null && val !== '') {
        input.value = val;
        input.classList.add('filled');
      }
    });
  }

  function clearForm() {
    FORM_SCHEMA.fields.forEach(f => {
      const input = document.getElementById('f_' + f.name);
      if (input) { input.value = ''; input.classList.remove('filled'); }
    });
  }

  // ── Coloration syntaxique JSON ──
  function colorizeJson(json) {
    return json
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+\.?\d*([eE][+-]?\d+)?)/g, match => {
        if (/^"/.test(match)) {
          return /:$/.test(match)
            ? `<span class="json-key">${match}</span>`
            : `<span class="json-str">${match}</span>`;
        }
        if (/true|false/.test(match)) return `<span class="json-bool">${match}</span>`;
        if (/null/.test(match))       return `<span class="json-null">${match}</span>`;
        return `<span class="json-num">${match}</span>`;
      });
  }

  // Envoi au clavier (Ctrl+Enter)
  document.getElementById('text-input').addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'Enter') extract();
  });
</script>
</body>
</html>